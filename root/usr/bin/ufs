#!/usr/bin/with-contenv bash
# reference: https://github.com/madslundt/docker-cloud-media-scripts/blob/master/scripts/mount.script

###############################################################################
# FUNCTIONS
###############################################################################

mount_union () {
	# Make sure combined plex media directory exists.
	local_media_dir="/data"
	if [ ! -d "${local_media_dir}" ]; then
		mkdir -p "${local_media_dir}"
	fi

	local_ufs_dir="/ufs"
	if [ ! -d "${local_ufs_dir}" ]; then
		mkdir -p "${local_ufs_dir}"
	fi

	sleep 5

	cloud_dir="/plexdrive"
	while [ -z "$(ls -A ${cloud_dir})" ]; do
		echo "Waiting for mount ${cloud_dir} ..."
		sleep 30
	done
	if [ ! -z ${PLEXDRIVE_SUB_PATH} ]; then
		cloud_dir="${cloud_dir}${PLEXDRIVE_SUB_PATH}"
	fi

	# Mount plex media directory if not already mounted.
	if [ $(ps -ef | grep "unionfs" | grep -v "grep" | wc -l) == "0" ]; then
		ufs_mounts="${local_ufs_dir}=RW:${cloud_dir}=RO"
		ufs_options="-o uid=${PUID:-911} -o gid=${PGID:-911} -o cow,allow_other,direct_io,nonempty,auto_cache,sync_read"

		echo "Executing => unionfs $ufs_options ${ufs_mounts} ${local_media_dir}"
		unionfs $ufs_options "${ufs_mounts}" "${local_media_dir}"
	fi
}

###############################################################################

if pidof -o %PPID -x "$(basename "$0")"; then
	echo "Mount already in progress. Aborting."
else
	mount_union
fi

exit 0
